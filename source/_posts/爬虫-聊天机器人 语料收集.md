---
title: çˆ¬è™«-èŠå¤©æœºå™¨äºº è¯­æ–™æ”¶é›†
date: 2019-10-6 14:30:38
tags:
  - Python
  - NLP
  - èŠå¤©æœºå™¨äºº
  - çˆ¬è™«
categories:
  - èŠå¤©æœºå™¨äºº
---

æœ€è¿‘è¢«åˆ†é…å¼„èŠå¤©æœºå™¨äººï¼ˆä½†ä¹Ÿæ˜¯å¾ˆäººå·¥ã€æš´åŠ›çš„åšæ³•ã€‚ã€‚ï¼‰ï¼Œåªåšå…¶ä¸­å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå…¥é—¨é˜¶æ®µã€‚å…¶é—´ï¼Œè¢«åˆ†äº†å†™ä¸ªçˆ¬è™«çˆ¬å°çˆ±ã€å°å†°çš„èŠå¤©å›å¤ï¼ˆç»™å®šæé—®è¯­æ–™ï¼‰ï¼Œé—®å¥éƒ½æ˜¯å•è®ºå¯¹è¯ã€‚

å› æ­¤ï¼Œè®°å½•ä¸‹å°çˆ±å’Œå°å†°çš„çˆ¬è™«pyä»£ç ï¼Œä»¥åæˆ–è®¸ä¼šç”¨åˆ°ğŸ™ƒã€‚



## 1. å°çˆ±æœºå™¨äºº-å›å¤çˆ¬è™«

```python
#!\usr\bin\env python
# -*- coding: utf-8 -*-
'''
Author: Eajack
date:2019/10/6
Functionï¼š
	å°çˆ±æœºå™¨äºº-è¯­æ–™å›å¤çˆ¬è™«
Attentionï¼š
	å®æµ‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œ1000~2000æ¡è¾“å…¥ä¼šæ–­1æ¬¡ï¼›éœ€è¦æ¢Cookie/ipç­‰ï¼›é»˜è®¤1ä¸ªå¥å­é—®3æ¬¡
'''

import requests
import re, time, json

headers = {
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3',
    'Accept-Encoding': 'gzip, deflate',
    'Accept-Language': 'zh-CN,zh;q=0.9',
    'Cache-Control': 'max-age=0',
    'Connection': 'keep-alive',
    'Cookie': 'XISESSIONID=1baeeit97b4ovtjaydvpmlj41',#cookieæ ¹æ®è‡ªå·±æµè§ˆå™¨F12æ”¹
    'Host': 'nlp.xiaoi.com',
    'Upgrade-Insecure-Requests': '1',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36'
}

def get_reply(input):
    url = "http://nlp.xiaoi.com/robot/webrobot?&callback=__webrobot_processMsg&data=%7B%22sessionId%22%3A%22a11f40dc641f4ccbb1d5d9a22a137083%22%2C%22robotId%22%3A%22webbot%22%2C%22userId%22%3A%227e90f929650684844babfe4bb629e7f1c%22%2C%22body%22%3A%7B%22content%22%3A%22{}%22%7D%2C%22type%22%3A%22txt%22%7D".format(input)
    r = requests.get(url, headers=headers)
    reply_all = r.text.split('__webrobot_processMsg')[-1]
    print(reply_all)
    reply_all = reply_all.replace('__webrobot_processMsg','')[1:-2]
    print(url)
    reply_all = json.loads(reply_all)

    try:
        reply = reply_all['body']['content'].strip()
    except KeyError:
        reply = reply_all['body']['data'].strip()

    return reply_all, reply

def main():
    with open('å°çˆ±-è¾“å…¥.txt', 'r', encoding='utf-8') as readFile:
        file_all = open('å°çˆ±-è¾“å‡º(æ‰€æœ‰ä¿¡æ¯).txt', 'w', encoding='utf-8')
        file_reply = open('å°çˆ±-è¾“å‡º.txt', 'w', encoding='utf-8')

        for line in readFile:
            input = line.strip()
            for i in range(3):#é»˜è®¤1ä¸ªå¥å­é—®3æ¬¡
                print('============================================')
                input = input.replace(r'&', r'%26')#å¯å»ï¼Œæ­¤å¤„å› ä¸ºurlç¼–ç æŠŠè¾“å…¥â€œ&â€æä¹±ï¼Œä¸‹%åŒ
                input = input.replace(r'%', r'%25')
                reply_all, reply = get_reply(input)
                reply_all_str = json.dumps(reply_all, ensure_ascii=False, \
                                           sort_keys=True, indent=4, separators=(',', ':')).strip()
                print(reply_all_str)
                print(reply)
                print('============================================')
                reply = re.sub(r'\s+', ' ', reply)

                file_all.write('{}\n\n'.format(reply_all_str))
                file_reply.write('{}&&{}\n'.format(input, reply))
                time.sleep(2)

            time.sleep(1)

        file_all.close()
        file_reply.close()

if __name__ == '__main__':
    main()
```

## 2. å°å†°æœºå™¨äºº-å›å¤çˆ¬è™«

å°å†°çš„æœ‰ç‚¹éº»çƒ¦ï¼Œæ²¡æ‰¾åˆ°å…¬å¼€çš„ç½‘å€å½¢å¼APIæ¥å£ã€‚æ­¤å¤„ç”¨çš„æ˜¯å¾®åšå°å†°æ¥å£ï¼Œéœ€è¦ç™»é™†å¾®åšï¼Œç”¨seleniumæ¨¡æ‹Ÿç™»é™†ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œçˆ¬è™«ä¸ä¼šæ–­ã€‚æœŸé—´éœ€è¦æ‰‹åŠ¨æ“ä½œ2æ¬¡ï¼šï¼ˆ1ï¼‰å¾®åšç™»é™†æœ‰ï¼Œä»£ç time.sleep(20) ç”¨äºæ‰‹åŠ¨æŒ‰éªŒè¯ç ï¼ˆ2ï¼‰ç§ä¿¡ç•Œé¢ååŒsleepï¼Œç”¨äºç‚¹å‡»å°å†°ç§ä¿¡çª—å£ã€‚åé¢å…¨è‡ªåŠ¨æ”¶é›†

```python
#!\usr\bin\env python
# -*- coding: utf-8 -*-
'''
Author: Eajack
date:2019/10/6
Functionï¼š
	å°å†°æœºå™¨äºº-è¯­æ–™å›å¤çˆ¬è™«
Attentionï¼š
	æ­¤å¤„ç”¨çš„æ˜¯å¾®åšå°å†°æ¥å£ï¼Œéœ€è¦ç™»é™†å¾®åšï¼Œç”¨seleniumæ¨¡æ‹Ÿç™»é™†ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œçˆ¬è™«ä¸ä¼šæ–­ã€‚æœŸé—´éœ€è¦æ‰‹åŠ¨æ“ä½œ2æ¬¡ï¼šï¼ˆ1ï¼‰å¾®åšç™»é™†æœ‰ï¼Œä»£ç time.sleep(20) ç”¨äºæ‰‹åŠ¨æŒ‰éªŒè¯ç ï¼ˆ2ï¼‰ç§ä¿¡ç•Œé¢ååŒsleepï¼Œç”¨äºç‚¹å‡»å°å†°ç§ä¿¡çª—å£ã€‚åé¢å…¨è‡ªåŠ¨æ”¶é›†
	é»˜è®¤1ä¸ªå¥å­é—®3æ¬¡
'''

import requests
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from bs4 import BeautifulSoup
import json,os,re,time

weiboNum = '*******'#è‡ªå·±çš„å¾®åšè´¦å·
WeiboPassword = '*******'#è‡ªå·±çš„å¾®åšå¯†ç 

def main():
    #å¾®åšç™»å½•
    global content_before_list
    weibo_loginUrl = r'https://passport.weibo.cn/signin/login'

    #1- å…ˆæ‰“å¼€ç™»é™†ç•Œé¢
    driver = webdriver.Chrome()
    time.sleep(5)
    driver.maximize_window()    #çª—å£æœ€å¤§åŒ–
    driver.implicitly_wait(10)  # éšå¼ç­‰å¾…
    driver.get(weibo_loginUrl)

    ## æ¨¡æ‹Ÿç™»å½•
    driver.find_element_by_id('loginName').clear()
    driver.find_element_by_id('loginName').send_keys(weiboNum)
    driver.find_element_by_id('loginPassword').clear()
    driver.find_element_by_id('loginPassword').send_keys(WeiboPassword)
    time.sleep(5)
    driver.find_element_by_id('loginAction').click()
    time.sleep(20)

    #2- æ‰“å¼€å°å†°ç§èŠç•Œé¢
    weibo_XiaoBingUrl = r'https://api.weibo.com/chat/#/chat?source_from=5'
    # æ‰“å¼€æ–°Tab
    js = r" window.open(' " + weibo_XiaoBingUrl + r"')"  # å¯ä»¥çœ‹åˆ°æ˜¯æ‰“å¼€æ–°çš„æ ‡ç­¾é¡µï¼Œä¸æ˜¯çª—å£
    driver.execute_script(js)
    time.sleep(5)
    # çª—å£åˆ‡æ¢
    # è·å–æ‰“å¼€çš„å¤šä¸ªçª—å£å¥æŸ„
    windows = driver.window_handles
    # åˆ‡æ¢åˆ°å½“å‰æœ€æ–°æ‰“å¼€çš„çª—å£
    driver.switch_to.window(windows[-1])

    # sleep äººå·¥ç‚¹å‡»å°å†°
    time.sleep(20)

    with open('å°å†°-è¾“å…¥.txt', 'r', encoding='utf-8') as readFile:
        ask2Reply = []
        flag = False

        for line in readFile:
            input = line.strip()
            for i in range(3):#é»˜è®¤1ä¸ªå¥å­é—®3æ¬¡
                print('============================================')

                try:
                    # è¾“å…¥æ–‡å­—
                    driver.find_element_by_id('webchat-textarea').clear()
                    driver.find_element_by_id('webchat-textarea').send_keys(input)
                    driver.find_element_by_id("webchat-textarea").send_keys(Keys.ENTER)
                    time.sleep(5)

                    html = driver.page_source
                    html_bs = BeautifulSoup(html, 'lxml')
                    content_now_list = html_bs.find_all("p", class_="puretext font14 c333 wordbreak")
                    content_now_list = [ item.get_text() for item in content_now_list ]

                    input_index = 0
                    for i in range(len(content_now_list)-1, -1, -1):
                        if content_now_list[i] == input:
                            input_index = i
                            break

                    reply_str = ' '.join(content_now_list[input_index+1:])
                    ask2Reply.append([input, reply_str])
                except Exception as e:
                    flag = True
                    break

            if(flag):
                break

        with open('å°å†°-è¾“å‡º.txt', 'a', encoding='utf-8') as writeFile:
            for item in ask2Reply:
                writeFile.write('{}&&{}\n'.format(item[0], item[1]))



if __name__ == '__main__':
    main()
```

## 3. è¾“å‡ºè¯­æ–™æ ¼å¼

ä»¥ä¸Šä»£ç è¾“å‡ºè¯­æ–™æ ¼å¼ä¸€è‡´ï¼Œå‡å¦‚ä¸‹

```
â€¦â€¦
è®²ä¸ªç¬‘è¯&&è€æ¿ï¼šâ€œä½ ç‰©æµä¸“ä¸šæ¯•ä¸šçš„ï¼Ÿâ€æˆ‘ï¼šâ€œæ˜¯çš„ã€‚â€è€æ¿ï¼šâ€œå¾ˆå¥½ï¼Œä½ é©¬ä¸Šå»å¸®æˆ‘æŠŠè¿™ä¸ªå¿«é€’å¯„äº†ã€‚â€
è®²ä¸ªç¬‘è¯&&æˆ‘ä¸ï¼è¯¥ä½ è®²äº†ï¼
è®²ä¸ªç¬‘è¯&&å¦ˆå¦ˆä¸Šç­è¯·å‡å›å®¶ï¼Œè¦å¸¦ä¸‰å²çš„å¥³å„¿å»é€›è¡—ã€‚å‡ºé—¨å‰å¦ˆå¦ˆå¯¹å¥³å„¿è¯´ï¼šå¿«å‘ä¿å§†é˜¿å§¨è¯´Bye-Byeã€‚å¥³å„¿ç…§è¯´Bye-Byeï¼Œå½“å¦ˆå¦ˆåˆè¯´ï¼šå‘é˜¿å§¨äº²ä¸€ä¸ªã€‚å¥³å„¿å¸¦ç€ææƒ§çš„çœ¼ç¥ï¼ŒæåŠ›çš„æ‘‡å¤´ä¸è‚¯äº²é˜¿å§¨ã€‚å¦ˆå¦ˆå¸¦ç€ç”Ÿæ°”çš„è¯­è¯´ï¼šä¸ºä»€ä¹ˆä¸äº²ï¼Ÿå¥³å„¿ä»å¸¦ç€ææƒ§çš„è¯­æ°”å¤§å£°è¯´ï¼šçˆ¸çˆ¸æ—©ä¸Šå·äº²é˜¿å§¨åï¼Œç»“æœè¢«æ‰“çš„å¥½æƒ¨ï¼
ä¹ˆä¹ˆå“’&&ä¹ˆä¹ˆ~ä¹ˆä¹ˆ
ä¹ˆä¹ˆå“’&&ä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆä¹ˆå“’
ä¹ˆä¹ˆå“’&&ä¹ˆä¹ˆå“’~è¦ä¸è¦æ¥ä¸ªå”‡è†
â€¦â€¦
```